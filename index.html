<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Guide Review Summary Tool</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 2rem; background: #f4f4f9; color: #333; }
    h1 { margin-bottom: 1.5rem; color: #4a148c; }
    .controls { margin-bottom: 1rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end; }
    .controls label { font-size: 0.9rem; color: #555; display: flex; flex-direction: column; }
    .controls input[type="number"], .controls input[type="file"], .controls button {
      padding: 0.4rem 0.6rem; border: 1px solid #ccc; border-radius: 4px;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); font-size: 0.9rem;
    }
    .controls button {
      background: #6a1b9a; color: #fff; border: none;
      cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transition: background 0.2s;
    }
    .controls button:hover { background: #4a148c; }
    table { border-collapse: collapse; width: 100%; background: #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    th, td { border: 1px solid #e0e0e0; padding: 0.8rem; vertical-align: top; }
    th { background: #f3e5f5; color: #4a148c; font-weight: 600; user-select: none; }
    .header-content { display: inline-flex; align-items: center; cursor: pointer; white-space: nowrap; }
    .chevron { margin-left: 0.4rem; font-size: 0.8rem; color: #6a1b9a; }
    ul { margin: 0; padding-left: 1rem; list-style-type: disc; }
  </style>
</head>
<body>
  <h1>Guide Review Summary Tool</h1>
  <div class="controls">
    <label>Min words per review
      <input type="number" id="minWords" value="5" min="1" step="1" />
    </label>
    <label>Similarity threshold
      <input type="number" id="simThreshold" value="0.8" min="0" max="1" step="0.05" />
    </label>
    <label>Upload CSV
      <input type="file" id="fileInput" accept=".csv" />
    </label>
    <button id="downloadBtn" style="display:none;">Download Summary CSV</button>
  </div>
  <div id="output"></div>

  <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://unpkg.com/compromise@13.11.3/builds/compromise.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const fileInput = document.getElementById('fileInput');
      const minWordsInput = document.getElementById('minWords');
      const thresholdInput = document.getElementById('simThreshold');
      const outputDiv = document.getElementById('output');
      const downloadBtn = document.getElementById('downloadBtn');
      let currentEntries = [];
      let sortDesc = true;

      function sim(a, b) {
        if (a === b) return 1;
        let m = 0;
        const len = Math.min(a.length, b.length);
        for (let i = 0; i < len; i++) if (a[i] === b[i]) m++;
        return m / len;
      }

      const stopwords = new Set(['the','a','and','but','then','nice','good','what','how','i','it','is','was','were','are','to','of','in','that','this','for','with','you','on','as','they','be','at','or','an','by','have','from','my','your','their','if','so','no','not','all','just','do','does','did','had','he','she','we','our','us','me','his','her','them']);
      const negativeWords = ['bad','poor','terrible','horrible','hate','worst','awful','not','never'];

      function renderTable(entries) {
        outputDiv.innerHTML = '';
        const sorted = entries.slice().sort((a, b) => sortDesc ? b.count - a.count : a.count - b.count);
        const table = document.createElement('table');
        const headerRow = document.createElement('tr');
        ['Guide','Review Count','Highlights','Reviews'].forEach(h => {
          const th = document.createElement('th');
          if (h === 'Review Count') {
            const span = document.createElement('span'); span.className = 'header-content';
            span.textContent = h;
            const chevron = document.createElement('span'); chevron.className = 'chevron'; chevron.textContent = sortDesc ? '▼' : '▲';
            span.appendChild(chevron);
            span.addEventListener('click', () => { sortDesc = !sortDesc; renderTable(currentEntries); });
            th.appendChild(span);
          } else {
            th.textContent = h;
          }
          headerRow.appendChild(th);
        });
        table.appendChild(headerRow);

        sorted.forEach(obj => {
          const tr = document.createElement('tr');
          const tdG = document.createElement('td'); tdG.textContent = obj.guide;
          const tdC = document.createElement('td'); tdC.textContent = obj.count;
          const tdH = document.createElement('td'); tdH.textContent = obj.highlights;
          const tdR = document.createElement('td');
          const ul = document.createElement('ul');
          obj.reviews.forEach(rv => { const li = document.createElement('li'); li.textContent = rv; ul.appendChild(li); });
          tdR.appendChild(ul);
          [tdG, tdC, tdH, tdR].forEach(td => tr.appendChild(td));
          table.appendChild(tr);
        });

        // setup download
        const rows = [['Guide','Review Count','Highlights','Reviews']];
        sorted.forEach(o => rows.push([o.guide, o.count, o.highlights, o.reviews.join(' | ')]));
        const csv = Papa.unparse(rows);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        downloadBtn.style.display = 'inline-block';
        downloadBtn.onclick = () => {
          const a = document.createElement('a');
          a.href = url;
          a.setAttribute('download', 'guide_review_summary.csv');
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        };

        outputDiv.appendChild(table);
      }

      function processFile(file) {
        const minWords = parseInt(minWordsInput.value, 10);
        const threshold = parseFloat(thresholdInput.value);

        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: ({ data, meta }) => {
            const revCol = meta.fields.find(f => /review/i.test(f)) || meta.fields[0];
            const subs = data.filter(r => {
              const txt = (r[revCol] || '').trim();
              if (txt.split(/\s+/).length <= minWords) return false;
              const lower = txt.toLowerCase();
              return !negativeWords.some(w => lower.includes(w));
            });

            const groups = {};
            subs.forEach(r => {
              const text = r[revCol];
              const people = nlp(text).people().out('array');
              if (!people.length) return;
              const name = people[0].split(/\s+/)[0];
              if (!/^[A-Z][a-z]+$/.test(name) || stopwords.has(name.toLowerCase())) return;
              (groups[name] || (groups[name] = [])).push(text);
            });

            const counts = {};
            Object.keys(groups).forEach(n => counts[n] = groups[n].length);
            const clusters = [];
            Object.keys(counts).sort().forEach(name => {
              let placed = false;
              for (const c of clusters) {
                if (sim(name.toLowerCase(), c[0].toLowerCase()) >= threshold) { c.push(name); placed = true; break; }
              }
              if (!placed) clusters.push([name]);
            });

            currentEntries = clusters.map(cluster => {
              const canon = cluster.reduce((a, b) => counts[a] >= counts[b] ? a : b);
              const reviews = cluster.flatMap(n => groups[n] || []);
              const highlights = (() => {
                const txt = reviews.join(' ').toLowerCase();
                const adjs = ['knowledgeable','excellent','interesting','informative','friendly','amazing','fantastic','detailed','passionate','enthusiastic','attentive','professional','engaging','dynamic','comprehensive','thorough','insightful','articulate','patient','personable'];
                const found = adjs.filter(a => txt.includes(a));
                if (found.length > 1) return 'Known for being ' + found.slice(0, -1).join(', ') + ' and ' + found.slice(-1) + '.';
                if (found.length === 1) return 'Known for being ' + found[0] + '.';
                return reviews[0].split('. ')[0] + '.';
              })();
              return { guide: canon, reviews, count: reviews.length, highlights };
            });

            renderTable(currentEntries);
          }
        });
      }

      fileInput.addEventListener('change', e => processFile(e.target.files[0]));
      [minWordsInput, thresholdInput].forEach(el => el.addEventListener('change', () => {
        if (fileInput.files[0]) processFile(fileInput.files[0]);
      }));
    });
  </script>
</body>
</html>

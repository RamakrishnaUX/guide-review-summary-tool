<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Guide Review Summary Tool</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f9f9f9; }
    h1 { margin-bottom: 1rem; }
    #output { margin-top: 1.5rem; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 1rem; }
    th, td { border: 1px solid #ddd; padding: 0.5rem; }
    th { background: #eee; }
    #downloadBtn { margin-top: 0.5rem; }
  </style>
</head>
<body>
  <h1>Guide Review Summary Tool</h1>
  <input type="file" id="fileInput" accept=".csv" />
  <div id="output"></div>
  <button id="downloadBtn" style="display:none;">Download Summary CSV</button>

  <!-- papaparse for CSV parsing -->
  <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
  <script>
    // simple sequence matcher for fuzzy grouping
    function sim(a,b){
      if(a===b) return 1;
      let m=0, M=a.length, N=b.length, min=Math.min(M,N);
      for(let i=0;i<min;i++) if(a[i]==b[i]) m++;
      return m/min;
    }

    document.getElementById('fileInput').addEventListener('change', e=>{
      const file = e.target.files[0];
      if(!file) return;

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: ({data, meta})=>{
          // 1. identify review column
          const revCol = meta.fields.find(f=>/review/i.test(f))||meta.fields[0];
          // 2. filter substantive (>5 words)
          let subs = data.filter(r=>{
            let t = (r[revCol]||'').trim();
            return t.split(/\s+/).length > 5;
          });
          // 3. extract guide names
          subs = subs.map(r=>{
            let t = r[revCol];
            let name = null;
            ;[
              /guide[s]?[,:\s]*([A-Z][a-z]+)/,
              /([A-Z][a-z]+)\s+our guide/,
              /guide\s+was\s+([A-Z][a-z]+)/
            ].some(reg=>{
              const m = reg.exec(t);
              if(m){ name=m[1]; return true; }
            });
            return name?{text:t,guide:name}:null;
          }).filter(x=>x);

          // 4. fuzzy-cluster spellings
          const counts = {};
          subs.forEach(x=>counts[x.guide]=(counts[x.guide]||0)+1);
          const names = Object.keys(counts).sort();
          const clusters = [], labels = {};
          names.forEach(n=>{
            let found=false;
            for(let c of clusters){
              if(sim(n,c[0])>=0.8){ c.push(n); found=true; break; }
            }
            if(!found) clusters.push([n]);
          });
          clusters.forEach(cluster=>{
            // pick most frequent as canonical
            const canon = cluster.reduce((a,b)=>counts[a]>=counts[b]?a:b);
            cluster.forEach(n=>labels[n]=canon);
          });
          subs.forEach(x=>x.canonical=labels[x.guide]);

          // 5. aggregate
          const agg = {};
          subs.forEach(x=>{
            const c = x.canonical;
            if(!agg[c]) agg[c]={reviews:[],count:0};
            agg[c].reviews.push(x.text);
            agg[c].count++;
          });

          // 6. highlights
          const adjs = ['knowledgeable','friendly','helpful','terrific','phenomenal','amazing','excellent','great','smooth','informative','engaging'];
          Object.values(agg).forEach(g=>{
            const txt = g.reviews.join(' ').toLowerCase();
            const found = adjs.filter(a=>txt.includes(a));
            if(found.length>1) g.highlights = 'Known for being '+found.slice(0,-1).join(', ')+' and '+found.slice(-1)+'.';
            else if(found.length===1) g.highlights = 'Known for being '+found[0]+'.';
            else g.highlights = g.reviews[0].split('. ')[0]+'.';
          });

          // render table
          const out = document.getElementById('output');
          out.innerHTML = '';
          const tbl = document.createElement('table');
          const hdr = document.createElement('tr');
          ['Guide','Review Count','Highlights','Reviews'].forEach(h=>{
            const th = document.createElement('th'); th.textContent = h; hdr.appendChild(th);
          });
          tbl.appendChild(hdr);
          Object.entries(agg).forEach(([guide,g])=>{
            const tr = document.createElement('tr');
            const makeCell = txt=>{
              const td = document.createElement('td');
              td.textContent = txt;
              return td;
            };
            tr.appendChild(makeCell(guide));
            tr.appendChild(makeCell(g.count));
            tr.appendChild(makeCell(g.highlights));
            tr.appendChild(makeCell(g.reviews.join(' | ')));
            tbl.appendChild(tr);
          });
          out.appendChild(tbl);

          // prepare CSV download
          const rows = [['Guide','Review Count','Highlights','Reviews']];
          Object.entries(agg).forEach(([guide,g])=>{
            rows.push([guide,g.count,JSON.stringify(g.highlights),JSON.stringify(g.reviews)]);
          });
          const csv = Papa.unparse(rows);
          const blob = new Blob([csv],{type:'text/csv'});
          const url = URL.createObjectURL(blob);
          const btn = document.getElementById('downloadBtn');
          btn.style.display='inline-block';
          btn.onclick=()=>{ 
            const a=document.createElement('a');
            a.href=url; 
            a.download='guide_review_summary.csv'; 
            a.click();
          };
        }
      });
    });
  </script>
</body>
</html>
